# F10/F11/F12/F14/F17/F19/F20-T3 integration log (worker F)

Date: 2026-02-15

## Files updated
- /Users/aaaaa/Projects/tui-visualizer/src/app.rs
- /Users/aaaaa/Projects/tui-visualizer/src/config.rs
- /Users/aaaaa/Projects/tui-visualizer/src/lib.rs
- /Users/aaaaa/Projects/tui-visualizer/src/capability.rs (new)
- /Users/aaaaa/Projects/tui-visualizer/src/prefs.rs (new)
- /Users/aaaaa/Projects/tui-visualizer/docs/USAGE.md
- /Users/aaaaa/Projects/tui-visualizer/docs/ARCHITECTURE.md
- /Users/aaaaa/Projects/tui-visualizer/README.md

## Implemented scope

### F10 capability probing + fallback
- Added startup probe module (`src/capability.rs`) for engine/renderer compatibility checks.
- Probe behavior focuses on Kitty graphics + Metal platform support.
- Added auto-probe flag (`--auto-probe`, default true).
- Added graceful fallback wiring in app startup:
  - `kitty` renderer -> `half-block` when Kitty graphics capability is missing.
  - `metal` engine -> `cpu` when unsupported/unavailable.
- Surfaced probe status in HUD + help overlay.

### F11 performance governor anti-oscillation
- Refined `RuntimeTuning` with:
  - EMA + hysteresis thresholds
  - over/under budget streak voting
  - cooldown frames after downscale/upscale actions
- Preserved stage mode interaction with stage-specific thresholds and cooldown profile.

### F12 latency-calibrated mode
- Added latency calibration runtime state:
  - optional auto calibration mode (`--latency-calibration`)
  - manual offset (`--latency-offset-ms`)
  - effective offset from manual + auto estimate
- Applied phase correction to beat/onset path before auto-switch + pulse logic.
- Added hotkeys:
  - `l`: toggle calibration mode
  - `-` / `=`: decrease/increase latency offset
  - `0`: reset manual latency offset
- HUD/help now display calibration status.

### F14 typography layer
- Added lightweight typography overlay modes with readability guardrails:
  - `off`
  - `line` pulse
  - `word` pulse
- Added hotkey:
  - `y`: cycle typography mode
- HUD/help display active typography mode and sample text.

### F17 + F03 + F07 runtime integration
- Added config flags:
  - `--theme-pack <path>`
  - `--control-matrix <path>`
  - `--preset-graph <path>`
- Startup loading behavior:
  - Parse theme pack, control matrix, preset graph when provided.
  - On success, apply defaults where available:
    - playlist defaults
    - initial preset selection
    - intensity default
    - zoom default
    - control routing (supported control names)
  - On parse/load failure: continue running with clear warning surfaced in HUD/help.

### F19 control wiring + F20-T3
- Wired camera path controls into app hotkeys/HUD using VisualEngine API:
  - `c`: cycle camera path mode
  - `,` / `.`: camera path speed down/up
- HUD now includes camera mode/speed + scene section labels.
- Added stage mode preference persistence (`src/prefs.rs`):
  - load on startup
  - save on init/toggle
  - path: `$XDG_CONFIG_HOME/tui_visualizer/prefs.txt` (fallback `~/.config/tui_visualizer/prefs.txt`)

## New/updated CLI flags
- `--auto-probe true|false`
- `--latency-calibration true|false`
- `--latency-offset-ms <f32>`
- `--theme-pack <path>`
- `--control-matrix <path>`
- `--preset-graph <path>`

## New/updated hotkeys
- `c`: cycle camera path mode
- `,` / `.`: camera path speed down/up
- `y`: cycle typography mode
- `l`: toggle latency auto-calibration
- `-` / `=`: latency offset down/up
- `0`: reset manual latency offset
- `g`: stage mode toggle (now persisted)

## Validation commands and results
1. `cargo build --release`
- Result: PASS
- Output: release build completed successfully.

2. `target/release/tui_visualizer --source system --engine metal --renderer kitty --stage-mode`
- Result: PASS (short smoke)
- Notes:
  - app entered render loop successfully
  - stage-mode path rendered frames
  - session exited cleanly via interrupt after short runtime
