# F05 + F19 + F01/F02 control-surface updates (worker A)

Date: 2026-02-15
File touched: /Users/aaaaa/Projects/tui-visualizer/src/visual/mod.rs

## Summary
Implemented scene-energy auto-DJ control with explicit section classes and hysteresis, added engine-level camera path mode/speed API surface, and aligned control-surface labeling for camera/transition modes with deterministic stepping behavior preserved.

## F05: Scene-energy auto-DJ
- Added `SceneSection` enum: `Calm`, `Groove`, `Drive`, `Impact`.
- Added explicit classifier:
  - `classify_scene_section(audio: &AudioFeatures) -> SceneSection`
- Added hysteresis state machine in `PresetEngine`:
  - state fields: `scene_section`, `scene_section_pending`, `scene_section_votes`, `scene_section_changed_at`
  - helper policies:
    - `section_hysteresis_votes(...)`
    - `section_hysteresis_hold(...)`
  - updater:
    - `update_scene_section_state(now, audio)`
- Bound section to transition policy:
  - new `suggest_transition_for_section(...)`
  - `suggest_transition(...)` now routes through classifier by default
  - `next_preset_auto(...)` uses stable engine section state when auto-selecting transition kind/duration
- Bound section to auto-switch pacing:
  - `Beat`: section-aware beats-per-switch (`section_beats_per_switch`)
  - `Energy`: section-aware energy + min-interval gates (`section_energy_gate`)
  - `Time`: section-aware interval scaling (`section_time_scale`)
  - `Adaptive`: section-aware target clamps, slam gates, and minimum spacing

## F19: Camera path presets (engine-level API in visual core)
- Added `CameraPathMode` enum:
  - `Auto`, `Orbit`, `Dolly`, `Helix`, `Spiral`, `Drift`
- Added `PresetEngine` camera path state:
  - `camera_path_mode` (default `Auto`)
  - `camera_path_speed` (default `1.0`)
- Added `PresetEngine` methods:
  - `cycle_camera_path_mode()`
  - `step_camera_path_mode(forward: bool)`
  - `camera_path_mode() -> CameraPathMode`
  - `camera_path_mode_name() -> &'static str`
  - `step_camera_path_speed(delta: f32)`
  - `camera_path_speed() -> f32`
- Backward compatibility:
  - No render-path behavior changed when mode remains `Auto` and speed `1.0`.

## F01/F02 control-surface alignment
- Cleaned transition operator labels:
  - `TransitionKind::operator_label()` introduced
  - `TransitionKind::label()` now delegates to `operator_label()`
  - Human-readable labels updated (e.g. `Luma Key`, `Flash Cut`)
- Exposed additional label helpers in engine surface:
  - `transition_mode_name()`
  - `transition_operator_name()`
  - `scene_section_name()`
  - `camera_path_mode_name()`
- Kept transition selection stepping/locking deterministic:
  - existing `step_transition_override(...)` semantics preserved
  - lock behavior remains override-based and deterministic

## VisualEngine trait API additions
Added defaulted methods to preserve compatibility for other visual engines (e.g. Metal engine impls can opt in without immediate compile breakage):
- `transition_mode_name(&self) -> &'static str` (default)
- `transition_operator_name(&self) -> &'static str` (default)
- `scene_section_name(&self) -> &'static str` (default)
- `cycle_camera_path_mode(&mut self)` (default no-op)
- `step_camera_path_mode(&mut self, forward: bool)` (default no-op)
- `camera_path_mode(&self) -> CameraPathMode` (default `Auto`)
- `camera_path_mode_name(&self) -> &'static str` (default)
- `step_camera_path_speed(&mut self, delta: f32)` (default no-op)
- `camera_path_speed(&self) -> f32` (default `1.0`)

## Validation
- Ran: `cargo build --release`
- Result: success

## Follow-up needed (Metal/app integration)
- App input layer:
  - Bind hotkeys/UI controls to new `VisualEngine` camera-path methods (`cycle/step/get` mode + speed).
- HUD/control surface:
  - Display `scene_section_name`, `camera_path_mode_name`, `transition_mode_name`, and `transition_operator_name` where relevant.
- Metal renderer integration:
  - If shader/camera uniforms should react to path mode/speed, plumb `camera_path_mode` + `camera_path_speed` through render context/state in platform engine code.
  - Current change is engine-state API only in visual core and is intentionally render-behavior neutral by default.
